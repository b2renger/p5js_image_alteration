var Voronoi,Aux;Voronoi={},Aux={inner:function(t,o){return t.x*o.x+t.y*o.y+t.z*o.z},sub:function(t,o){return{x:t.x-o.x,y:t.y-o.y,z:t.z-o.z}},cross:function(t,o){return{x:t.y*o.z-t.z*o.y,y:t.z*o.x-t.x*o.z,z:t.x*o.y-t.y*o.x}}},Voronoi.Treemap=function(t,o,n,e,i){var r,h,s,a,u,l;for(null==i&&(i=0),this.root=t,this.omega=o,this.width=n,this.height=e,this.lv=i,r=[],h=0,a=(s=t.children).length;a>h;++h)u=s[h],r.push((u.x=Math.random()*n,u.y=Math.random()*e,u.lv=i,u));for(this.sites=r,0===i&&this.normalizeValue(t,Polygon.area(o),this.correctValue(t)),this.boundmap=new Voronoi.Boundmap(this.sites,o,n,e,!0),this.boundmap.compute(),this.treemap=[],h=0,a=(s=t.children).length;a>h;++h)l=h,u=s[h],u.children&&this.treemap.push(new Voronoi.Treemap(u,this.boundmap.polygons[l],n,e,i+1));return this},Voronoi.Treemap.prototype={updateValue:function(){var t,o,n,e;for(this.normalizeValue(this.root,Polygon.area(this.omega),this.correctValue(this.root)),this.boundmap=new Voronoi.Boundmap(this.sites,this.omega,this.width,this.height,!0),t=0,n=(o=this.treemap).length;n>t;++t)e=o[t],e.updateValue();return this.compute()},correctValue:function(t){var o,n,e,i;for(null==t&&(t=this.sites),o=0,e=(n=t.children||[]).length;e>o;++o)i=n[o];return t.value=function(){var o,n,e,r=[];for(o=0,e=(n=t.children||[]).length;e>o;++o)i=n[o],r.push(this.correctValue(i||null));return r}.call(this).reduce(function(t,o){return t+o},0)||t.value||0},normalizeValue:function(t,o,n){var e,i,r,h,s=[];for(t.value=.05*t.value*o/n,e=0,r=(i=t.children||[]).length;r>e;++e)h=i[e],s.push(this.normalizeValue(h,o,n));return s},compute:function(){var t=this;return this.boundmap.compute(),this.treemap.forEach(function(o,n){return o.setOmega(t.boundmap.polygons[n]),o.compute()})},getSites:function(){var t;return[this.boundmap.sites].concat([function(){var o,n=[];for(o=0;4>o;++o)t=o,n.push({boundary:!0});return n}()],this.treemap.map(function(t){return t.getSites()})).reduce(function(t,o){return t.concat(o)},[])},getPolygons:function(){return[this.boundmap.polygons].concat(this.treemap.map(function(t){return t.getPolygons()})).reduce(function(t,o){return t.concat(o)},[])},setOmega:function(t){return this.omega=t,this.boundmap=new Voronoi.Boundmap(this.sites,t,this.width,this.height)}},Voronoi.Boundmap=function(t,o,n,e,i){var r,h;return this.sites=t,this.omega=o,this.width=n,this.height=e,null==i?(r=t.reduce(function(t,o){return t+o.value},0),h=Polygon.area(o),t.forEach(function(t){return t.nvalue=.1*t.value*h/r})):t.forEach(function(t){return t.nvalue=t.value}),t.forEach(function(t){return t.nvalue=t.value}),this.powerbox=new Voronoi.PowerDiagram(t,n,e),this.powerbox.compute(),this.clip(),this},Voronoi.randomSite=function(t,o,n,e){var i;return function(){var r,h,s=[];for(r=0,h=t;h>r;++r)i=r,s.push({x:o*Math.random(),y:n*Math.random(),value:1+Math.random()*e});return s}().map(function(t){return t.weight=t.value,t})},Voronoi.Boundmap.prototype={clip:function(){var t=this;return this.polygons=this.powerbox.convex.polygons.map(function(o){return o?Voronoi.Polygon.intersect(t.omega,o):[]}),this.centroids=this.polygons.map(function(t){return t?Voronoi.Polygon.centroid(t):{x:null,y:null}})},adoptPos:function(){var t,o,n,e,i,r,h,s,a,u,l,c,p,g,m,y=[];for(t={sites:this.sites,centroids:this.centroids,polygons:this.polygons},o=t.sites,n=t.centroids,e=t.polygons,i=0,r=n.length-4;r>i;++i)h=i,o[h]&&e[h]&&!o[h].boundary&&(e[h].length?(t=[n[h].x,n[h].y],o[h].x=t[0],o[h].y=t[1]):(t=[this.width*Math.random(),this.height*Math.random()],o[h].x=t[0],o[h].y=t[1]));for(i=0,r=n.length-4;r>i;++i)if(h=i,o[h]&&e[h].length&&!o[h].boundary){for(t=[Math.sqrt(o[h].weight),-1],s=t[0],a=t[1],u=0,l=e[h].length;l>u;++u)c=u,t=[e[h][c],e[h][(c+1)%e[h].length]],p=t[0],g=t[1],m=10*Math.abs(((g.y-p.y)*o[h].x-(g.x-p.x)*o[h].y+g.x*p.y-g.y*p.x)/Math.sqrt(Math.pow(g.y-p.y,2)+Math.pow(g.x-p.x,2))),(-1===a||a>m)&&(a=m);s=Math.pow(Math.min(s,a),2),y.push(o[h].weight=s)}return y},resetWeight:function(){return this.sites.forEach(function(t){return t.weight=t.pvalue=t.nvalue})},adoptWeight:function(){var t,o,n,e,i,r,h,s,a,u,l,c,p,g,m,y,d,f,v=[];for(t={sites:this.sites,centroids:this.centroids,polygons:this.polygons},o=t.sites,n=t.centroids,e=t.polygons,i=0,o.forEach(function(t){return i+=t.nvalue,t.pvalue!==t.nvalue&&(t.weight=t.nvalue),t.pvalue=t.nvalue}),r=Voronoi.Polygon.area(this.omega),h=0,s=n.length-4;s>h;++h)if(a=h,o[a]&&e[a].length&&!o[a].boundary){for(u=r*o[a].nvalue/i,l=Polygon.area(e[a]),c=Math.sqrt(o[a].weight),p=Math.sqrt(o[a].weight)*u/l,c=.5*(p-c)+c,g=-1,m=0,y=n.length-4;y>m;++m)d=m,a!==d&&this.polygons[d]&&(f=Math.sqrt(Math.pow(n[d].x-o[a].x,2)+Math.pow(n[d].y-o[a].y,2)),isNaN(f)||(-1===g||g>f)&&(g=f));c=Math.pow(Math.min(c,g),2),c<this.powerbox.epsilon&&(c=this.powerbox.epsilon),v.push(o[a].weight=c)}return v},compute:function(){return this.adoptPos(),this.powerbox=new Voronoi.PowerDiagram(this.sites,this.width,this.height),this.powerbox.compute(),this.clip(),this.adoptWeight(),this.powerbox=new Voronoi.PowerDiagram(this.sites,this.width,this.height),this.powerbox.compute(),this.clip()}},Voronoi.PowerDiagram=function(t,o,n){var e=this;return this.sites=t,this.width=o,this.height=n,this.boundary=[{x:-o,y:-n,boundary:!0},{x:-o,y:2*n,boundary:!0},{x:2*o,y:-n,boundary:!0},{x:2*o,y:2*n,boundary:!0}].map(function(t){return t.boundary=!0,t.weight=e.epsilon,t.value=e.epsilon,t}),this.convex=new Voronoi.Convex(JSON.parse(JSON.stringify(t.concat(this.boundary)))),this},Voronoi.PowerDiagram.prototype={epsilon:1e-10,compute:function(){return this.convex.calculate()}};var Polygon;Voronoi.Polygon=Polygon={},Polygon.centroid=function(n){var e,r,t,o,y,u,x,h,l;if(!n||!n.length)return{x:0/0,y:0/0};for(e=n.length,r=[0,0,0],t=r[0],o=r[1],y=r[2],u=0;e>u;++u)x=u,r=[n[x],n[(x+1)%e]],h=r[0],l=r[1],t+=(h.x+l.x)*(h.x*l.y-l.x*h.y),o+=(h.y+l.y)*(h.x*l.y-l.x*h.y),y+=3*(h.x*l.y-l.x*h.y);return{x:t/y,y:o/y}},Polygon.area=function(n){var e,r,t,o;return function(){var y,u,x,h=[];for(y=0,u=n.length;u>y;++y)e=y,r=(e+1)%n.length,x=[n[e],n[r]],t=x[0],o=x[1],h.push(t.x*o.y-t.y*o.x);return h}().reduce(function(n,e){return n+e/2},0)},Polygon.intersect=function(n,e){function r(n,e){return n+e.x}function t(n,e){return n+e.y}var o,y,u,x,h,l,g,c,f,i,a,P,s,d,v,p,M,I,w,V,b,j,k,m,q,z,A,B,C,D,E,F;if(!n||!n.length)return[];for(o=n.reduce(function(n,e){return n+e.x},0)/n.length,y=n.reduce(function(n,e){return n+e.y},0)/n.length,u=0,x=n.length;x>u;++u){for(h=u,l=[n[h],n[(h+1)%n.length]],g=l[0],c=l[1],l=[c.x-g.x,c.y-g.y],f=l[0],i=l[1],a=e.reduce(r,0)/e.length,P=e.reduce(t,0)/e.length,s=g.x*i-g.y*f,v=[],p=0,M=e.length;M>p;++p)I=p,l=[e[I],e[(I+1)%e.length]],w=l[0],V=l[1],l=[V.x-w.x,V.y-w.y],b=l[0],j=l[1],j*f-b*i!==0&&(k=(w.x*i-w.y*f-s)/(j*f-b*i),0>k||k>1||(l=[w.x+b*k,w.y+j*k],m=l[0],q=l[1],l=[a-m,P-q],z=l[0],A=l[1],B=(-f*j+i*b)*(-z*j+A*b)>0,v.push([k,I,m,q,B])));if(d=v,d.length<2){if((-(o-g.x)*i+(y-g.y)*f)*(-(a-g.x)*i+(P-g.y)*f)<0)return[]}else{l=d[0][4]?[d[0],d[1]]:[d[1],d[0]],C=l[0],D=l[1],E=[{x:C[2],y:C[3]},{x:D[2],y:D[3]}],F=D[1];do F=(F+1)%e.length,E.push(e[F]);while(F!==C[1]);e=E}}return e},Polygon.create=function(n,e,r){var t,o,y=[];for(3>r&&(r=3),t=0;r>t;++t)o=t,y.push({x:1*(n/2+n/2*Math.cos(2*Math.PI*o/r)),y:1*(e/2+e/2*Math.sin(2*Math.PI*o/r))});return y};function import$(t,r){var s={}.hasOwnProperty;for(var e in r)s.call(r,e)&&(t[e]=r[e]);return t}Voronoi.face=function(t,r,s){var e,i,n,h,o,x,y,a,u,z,p,l,v,c,f,d,m,g,w,M,V,$;for(null==s&&(s=!1),this.convex=t,this.idx=r,this.active=s,this.removed=!1,this.pts=(e=[t.pts[r[0]],t.pts[r[1]],t.pts[r[2]]],i=e[0],n=e[1],h=e[2],e),o=t.center,e=[h.x-i.x,h.y-i.y,h.z-i.z],x=e[0],y=e[1],a=e[2],e=[n.x-i.x,n.y-i.y,n.z-i.z],u=e[0],z=e[1],p=e[2],this.norm=l={x:y*p-a*z,y:a*u-x*p,z:x*z-y*u},v=Math.pow(l.x,2)+Math.pow(l.y,2)+Math.pow(l.z,2),this.norm=l={x:l.x/v,y:l.y/v,z:l.z/v},c=l.x*(o.x-i.x)+l.y*(o.y-i.y)+l.z*(o.z-i.z),c>0?(e=[-l.x,-l.y,-l.z],l.x=e[0],l.y=e[1],l.z=e[2],this.pts.reverse(),r.reverse()):0===c&&(this.trivial=!0),f=[],d=0;3>d;++d)m=d,g=(m+1)%3,e=r[m]>r[g]?[r[g],r[m]]:[r[m],r[g]],w=e[0],M=e[1],f.push((e=(V=(($=t.edges)[w]||($[w]={}))[M])?V:(($=t.edges)[w]||($[w]={}))[M]=[w,M],e.ref=0,e));return this.edges=f,this.precal=l.x*i.x+l.y*i.y+l.z*i.z,this},import$(Voronoi.face.prototype,{front:function(t){var r;return r=this.norm,r.x*t.x+r.y*t.y+r.z*t.z-this.precal>0},getCenter:function(){var t,r,s;return t=[{x:0,y:0},this.pts.length],r=t[0],s=t[1],this.pts.forEach(function(t){var s;return s=[r.x+t.x,r.y+t.y],r.x=s[0],r.y=s[1],s}),r.x=r.x/s,r.y=r.y/s,r.z=-100,r},dual:function(){var t,r,s,e,i,n,h,o,x,y,a,u,z,p,l,v,c;return this.dual.value&&this.dual.value,t=this.pts[0],r=t.x,s=t.y,e=t.z,t=this.pts[1],i=t.x,n=t.y,h=t.z,t=this.pts[2],o=t.x,x=t.y,y=t.z,a=s*(h-y)+n*(y-e)+x*(e-h),u=e*(i-o)+h*(o-r)+y*(r-i),z=r*(n-x)+i*(x-s)+o*(s-n),p=r*(n*y-x*h)+i*(x*e-s*y)+o*(s*h-n*e),l=.5*-a/z,v=.5*-u/z,c=-p/z,this.dual.value={x:l,y:v,z:c},this.dual.value}});function import$(t,r){var i={}.hasOwnProperty;for(var n in r)i.call(r,n)&&(t[n]=r[n]);return t}function in$(t,r){for(var i=-1,n=r.length>>>0;++i<n;)if(t===r[i])return!0;return!1}Voronoi.Convex=function(t){function r(t){return l.center[t]=[0,1,2,3].reduce(function(r,i){return r+l.pts[o[i]][t]},0)/4}function i(t){return t.map(function(t){return o[t]})}function n(t){return t.trivial}function e(t,r){var i;return i=Aux.sub(l.center,l.pts[t]),["x","y","z"].reduce(function(t,r){return t+Math.pow(i[r],2)},0),[i,r]}function s(t,r){return t[0]-r[0]}var h,o,u,f,a,c,p,l=this;if(this.pts=t,this.polygons=[],this.edges={},this.pts.forEach(function(t){return t.z=Math.pow(t.x,2)+Math.pow(t.y,2)-t.weight}),this.pair={f2p:{},p2f:{}},this.faces.list=[],!(this.pts.length<4)){for(h=[[0,1,2,3],3],o=h[0],this.idx=h[1];this.idx<this.pts.length;){for(this.idx++,this.center={},["x","y","z"].map(r),f=[],a=0,c=(h=[[0,1,2],[0,1,3],[0,2,3],[1,2,3]].map(i)).length;c>a;++a)p=h[a],f.push(new Voronoi.face(this,p));if(u=f,!u.filter(n).length)break;p=o.map(e).sort(s)[0][1],o.splice(o.indexOf(p),1),o.push(this.idx)}return this.faces.add(u),u.forEach(function(t,r){return l.pts.forEach(function(i,n){return t.front(i)?l.setPair(r,n,t,i):void 0})}),this}},import$(Voronoi.Convex.prototype,{getPairByPtr:function(t){return this.pair.p2f[t]||[]},getPairByFace:function(t){return this.pair.f2p[t]||[]},setPair:function(t,r,i,n){var e,s;return((e=(s=this.pair).f2p||(s.f2p={}))[t]||(e[t]=[])).push(n),((e=(s=this.pair).p2f||(s.p2f={}))[r]||(e[r]=[])).push(i)},faces:{contain:function(t){return in$(t,this.list)},add:function(t){return Array.isArray(t)?this.list=this.list.concat(t):this.list.push(t)},remove:function(t){var r=this;return Array.isArray(t)||(t=[t]),t.forEach(function(t){var i;return i=r.list.indexOf(t),i>=0?r.list.splice(i,1):void 0})}},polygonReorder:function(t){var r,i,n,e;return r=t.reduce(function(t,r){return t+r.x},0)/t.length,i=t.reduce(function(t,r){return t+r.y},0)/t.length,n=Math.pow(r,2)+Math.pow(i,2),e=function(t){var e,s,h;return e=Math.sqrt(n*(Math.pow(t.x-r,2)+Math.pow(t.y-i,2))),s=Math.acos((-r*(t.x-r)-i*(t.y-i))/e),h=Math.acos((i*(t.x-r)-r*(t.y-i))/e),h>Math.PI/2&&(s=6.28-s),s},t.sort(function(t,r){return e(t)-e(r)})},grid:function(){function t(t,r){return t+r.x}function r(t,r){return t+r.y}var i,n,e,s,h,o,u,f,a,c,p,l,d,g,x,y,v,m,w=[];for(this.faces.list.forEach(function(t){return t.center=t.getCenter(),t}),this.faces.list=this.faces.list.filter(function(t){return!t.removed&&t.front(t.center)}),i=[],n=0,e=this.pts.length;e>n;++n)s=n,i.push([]);for(this.polygons=i,n=0,o=(h=this.pts).length;o>n;++n)u=h[n],u.visited=!1;for(f=[],n=0,o=(h=this.faces.list).length;o>n;++n){for(a=h[n],c=[],p=0,d=(l=a.idx).length;d>p;++p)if(u=l[p],!in$(u,f)){for(f.push(u),g=[],g.idx=u,x=0,v=(y=this.faces.list).length;v>x;++x)s=x,m=y[x],in$(u,m.idx)&&g.push(m.dual());this.polygonReorder(g),g.cx=g.reduce(t,0)/g.length,g.cy=g.reduce(r,0)/g.length,this.pts[u].boundary&&(g.boundary=!0),c.push(this.polygons[u]=g)}w.push(c)}return w},calculate:function(){for(;this.idx<this.pts.length;)this.iterate();return this.grid()},iterate:function(){var t,r,i,n,e,s,h,o,u,f,a,c,p,l,d,g,x,y,v,m,w,M;if(t=(new Date).getTime(),!(this.idx>=this.pts.length)){for(r=this.getPairByPtr(this.idx),i=[],n=0,e=r.length;e>n;++n)if(s=r[n],!s.removed)for(h=0,u=(o=s.edges).length;u>h;++h)f=o[h],f.ref?f.dup=!0:i.push(f),f.ref++;return a=i.filter(function(t){return t.ref<2}),r.map(function(t){return t.removed=!0}),c=(new Date).getTime(),this.faces.add(p=function(){var t,r,i,n=[];for(t=0,i=(r=a).length;i>t;++t)f=r[t],n.push(new Voronoi.face(this,f.concat([this.idx]),!0));return n}.call(this)),o=[this.pts,this.pair,this.idx,this.faces.list.length,this.pts.length,p.length],l=o[0],d=o[1],g=o[2],x=o[3],y=o[4],v=o[5],m=(new Date).getTime(),p.forEach(function(t,r){var i,n,e,s,h,o,u,f=[];for(r+=x-v,i=[t.norm,t.precal],n=i[0],e=i[1],s=g+1,h=y;h>s;++s)o=s,u=l[o],n.x*u.x+n.y*u.y+n.z*u.z-e>0&&(((i=d.f2p)[r]||(i[r]=[])).push(u),f.push(((i=d.p2f)[o]||(i[o]=[])).push(t)));return f}),this.idx++,w=(new Date).getTime(),this.e1=(null!=(M=this.e1)?M:0)+(c-t),this.e2=(null!=(M=this.e2)?M:0)+(m-c),this.e3=(null!=(M=this.e3)?M:0)+(w-m)}}});